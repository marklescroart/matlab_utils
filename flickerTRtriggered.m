function flicker(designfile)% function flicker(designfile)% 11/2004 BT wrote it for the fMRI class% 2/2006 BT modified it to use TR trigger% designfile = 'designER.txt' or 'desingBK.txt'% Requires Psychtoolbox (Don't know what it is? Ask Google.)% Check the clockwarning off;%getsecstest;scr = 0;% loading the designfid = fopen(designfile,'r');design = fscanf(fid,'%d ');fclose(fid);numTrial = length(design)theFrameRate = framerate(scr);trialDurInTR = 1 % in TR (we use TR=2)stimDurInSec = 1 % in secsflickerRate = 12; %HzflickerFrame = floor(flickerRate/theFrameRate/2); %use floor instead of round, since time does not go backwardleadinInTR = 0 %TR (0 lead in/out -- use design file to specific lead in/out)leadoutInTR = 0totalTimeInTR = leadinInTR + numTrial*trialDurInTR + leadoutInTRinput('Apply Exam. Wait for "Continue". Press Enter to set fixation screen. Continue scan.');% prepare the stimuligray = 127; black = 0; white = 255;color1 = 10;checksz = 64; %pixelscreenRect = [0 0 1024 768];[x y] = meshgrid(1:(screenRect(4)/checksz),1:(screenRect(4)/checksz));check = ((-1).^(x+y))>0;check = expand(check,checksz);check = double(check) + color1; % we will do clut animation at entries color1 and color1+1;pixRect = [0 0 size(check,2) size(check,1)];[x y] = meshgrid((1:pixRect(4))-pixRect(4)/2,(1:pixRect(3))-pixRect(3)/2);ang = atan2(y,x);theta = 22.5/180*pi;check(ang>theta | ang<-theta) = gray;%check(ang>pi/2+theta | ang<pi/2-theta) = gray; %for our 90deg rotated displayimg{1} = ones(size(check))*gray; % Event 1: fixationimg{2} = check;                  % Event 2img{3} = rot90(rot90(img{2}));   % Event 3% open windowwindow=SCREEN(scr,'OpenWindow', [gray],screenRect,8);screen(window,'preference','SetClutCallsWaitBlanking',1); % make sure setclut is done during blankinghidecursor;% loading the stmuli into bufferfor i=1:3    offScr(i) = SCREEN(window, 'OpenOffscreenWindow', 255, pixRect);    SCREEN(offScr(i), 'PutImage', img{i}, pixRect);    SCREEN(offScr(i), 'FillOval', [white], centerrect([0 0 12 12], pixRect));    SCREEN(offScr(i), 'FillOval', [black], centerrect([0 0 8 8], pixRect));endwinRect = centerrect(pixRect,screenRect);% build CLUTsclut{1} = repmat([0:255]',[1,3]);clut{1}(color1+1,:) = black;clut{1}(color1+2,:) = white;clut{2} = clut{1};clut{2}(color1+1,:) = white;clut{2}(color1+2,:) = black;%experiment beginsSCREEN('CopyWindow', offScr(1), window, [], winRect);screen(window,'setclut',clut{1});for i = 1:leadinInTR    waittrigger%% run up the clockend% The Trial loopci = 1;for i = 1:numTrial    cond = design(i); % 1 is fixation    trCounter = 0;    firstTR = 1;    playStim = 1;    while trCounter < trialDurInTR        waittrigger;        if firstTR            trialStart = getsecs;            firstTR = 0;            stimEnd = trialStart+stimDurInSec;            screen('copywindow',offScr(cond), window, [], winRect);        end        trCounter = trCounter + 1;        while ~charavail & getsecs<stimEnd            % clut animation            screen(window,'setclut',clut{ci});            ci = mod(ci,2)+1;            nextFlickTime = getsecs+1/flickerRate;            while getsecs < nextFlickTime                %run the clock            end        end        if playStim & getsecs>=stimEnd            playStim = 0;            screen('copywindow',offScr(1),window,[],winRect);        end    endend% Show Final FixationSCREEN('CopyWindow', offScr(1), window, [], winRect);for i = 1:leadoutInTR    waittrigger;endshowcursor;SCREEN('CloseAll');warning on;%%%%%function [resp, timestamp] = waittrigger()tr = [];resp = [];while tr~='5'    tr=getchar;    if tr == 'q'        exit(0);    elseif tr ~= '5'        resp = tr;        timestamp = getsecs;    endend